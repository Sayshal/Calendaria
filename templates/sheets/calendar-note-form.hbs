<div class="calendar-note-form">
  {{log 'DEBUG' this}}
  {{!-- Row 1: Title | Emblem | Visibility --}}
  <div class="form-row-1">
    <fieldset class="title-fieldset">
      <legend>Title</legend>
      <input type="text" id="note-name" name="name" value="{{name}}" placeholder="{{localize 'CALENDARIA.Note.NewNote'}}" />
    </fieldset>

    <fieldset class="emblem-fieldset">
      <legend>Emblem</legend>
      <div class="emblem-controls">
        <div class="icon-picker" data-action="selectIcon" data-icon-type="{{iconType}}"
          data-tooltip="CALENDARIA.UI.IconPickerTooltip">
          {{#if (eq iconType "fontawesome")}}
            <i class="{{system.icon}} icon-preview" style="color: {{system.color}}"></i>
          {{else}}
            <img src="{{system.icon}}" alt="Note Icon" class="icon-preview"
              style="filter: drop-shadow(0px 1000px 0 {{system.color}}); transform: translateY(-1000px);" />
          {{/if}}
          <input type="hidden" name="system.icon" value="{{system.icon}}" />
          <input type="hidden" name="system.iconType" value="{{iconType}}" />
        </div>
        <input type="color" name="system.color" value="{{system.color}}" class="color-input"
          data-tooltip="CALENDARIA.UI.ColorTooltip" />
      </div>
    </fieldset>

    <fieldset class="visibility-fieldset">
      <legend>Visibility</legend>
      <label class="visibility-control">
        <input type="checkbox" name="system.gmOnly" {{checked system.gmOnly}}
          data-tooltip="CALENDARIA.UI.GmOnlyTooltip" />
        GM Only
      </label>
      <label class="visibility-control">
        <input type="checkbox" name="system.silent" {{checked system.silent}}
          data-tooltip="CALENDARIA.UI.SilentTooltip" />
        Don't Announce
      </label>
    </fieldset>
  </div>

  {{!-- Row 2: Date | Time | Repeat --}}
  <div class="form-row-2">
    <fieldset class="date-fieldset">
      <legend>Date</legend>
      <div class="date-inputs">
        <div class="date-row">
          <label>Start</label>
          <button type="button" class="date-picker-button" data-action="selectDate" data-date-field="startDate"
            data-tooltip="CALENDARIA.UI.StartDateTooltip">
            <i class="fas fa-calendar-alt"></i>
            <span class="date-display">{{startDateDisplay}}</span>
          </button>
          <input type="hidden" name="system.startDate.year" value="{{system.startDate.year}}" />
          <input type="hidden" name="system.startDate.month" value="{{system.startDate.month}}" />
          <input type="hidden" name="system.startDate.day" value="{{system.startDate.day}}" />
        </div>

        <div class="date-row">
          <label>End</label>
          <button type="button" class="date-picker-button" data-action="selectDate" data-date-field="endDate"
            data-tooltip="CALENDARIA.UI.EndDateTooltip">
            <i class="fas fa-calendar-alt"></i>
            <span class="date-display">{{endDateDisplay}}</span>
          </button>
          <input type="hidden" name="system.endDate.year" value="{{system.endDate.year}}" />
          <input type="hidden" name="system.endDate.month" value="{{system.endDate.month}}" />
          <input type="hidden" name="system.endDate.day" value="{{system.endDate.day}}" />
        </div>
      </div>
    </fieldset>

    <fieldset class="time-fieldset">
      <legend>Time</legend>
      <div class="time-inputs">
        <div class="time-row">
          <label>Start</label>
          <input type="time" name="system.startDate.time" value="{{startTimeValue}}"
            {{#if system.allDay}}disabled{{/if}} data-tooltip="CALENDARIA.UI.StartTimeTooltip" />
          <input type="hidden" name="system.startDate.hour" value="{{system.startDate.hour}}" />
          <input type="hidden" name="system.startDate.minute" value="{{system.startDate.minute}}" />
          <label class="all-day-label">
            <input type="checkbox" name="system.allDay" {{checked system.allDay}}
              data-tooltip="CALENDARIA.UI.AllDayTooltip" />
            All Day
          </label>
        </div>
        <div class="time-row">
          <label>End</label>
          <input type="time" name="system.endDate.time" value="{{endTimeValue}}" {{#if system.allDay}}disabled{{/if}}
            data-tooltip="CALENDARIA.UI.EndTimeTooltip" />
          <input type="hidden" name="system.endDate.hour" value="{{system.endDate.hour}}" />
          <input type="hidden" name="system.endDate.minute" value="{{system.endDate.minute}}" />
        </div>
      </div>
    </fieldset>

    <fieldset class="repeat-fieldset">
      <legend>Repeat</legend>
      <select name="system.repeat" data-tooltip="CALENDARIA.UI.RepeatTooltip">
        {{#each repeatOptions}}
          <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
        {{/each}}
      </select>
      {{#if showRepeatOptions}}
        <div class="repeat-options">
          <label data-tooltip="CALENDARIA.UI.MaxOccurrencesTooltip">
            Max
            <input type="number" name="system.maxOccurrences" value="{{system.maxOccurrences}}" min="0" step="1"
              placeholder="âˆž" />
          </label>
        </div>
      {{/if}}
    </fieldset>
  </div>

  {{!-- Moon Conditions (shown when repeat is 'moon' or conditions exist) --}}
  {{#if showMoonConditions}}
    <div class="form-row-moon">
      <fieldset class="moon-conditions-fieldset">
        <legend>Moon Conditions</legend>
        {{#if hasMoons}}
          {{!-- Existing conditions --}}
          {{#if moonConditions.length}}
            <div class="moon-conditions-list">
              {{#each moonConditions}}
                <div class="moon-condition-tag">
                  <span class="moon-name">{{moonName}}</span>
                  <span class="phase-name">{{phaseName}}</span>
                  <button type="button" class="remove-condition" data-action="removeMoonCondition"
                    data-index="{{index}}" data-tooltip="Remove condition">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              {{/each}}
            </div>
          {{/if}}
          {{!-- Add new condition --}}
          <div class="add-moon-condition">
            <select name="newMoonCondition.moonIndex">
              <option value="">Select Moon...</option>
              {{#each moons}}
                <option value="{{index}}">{{name}}</option>
              {{/each}}
            </select>
            <select name="newMoonCondition.phase">
              <option value="">Select Phase...</option>
              {{#each moons}}
                {{#each phases}}
                  <option value="{{start}}-{{end}}" data-moon="{{@../index}}">{{name}}</option>
                {{/each}}
              {{/each}}
            </select>
            <button type="button" class="add-condition-btn" data-action="addMoonCondition"
              data-tooltip="Add moon condition">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <p class="hint">Event triggers on days matching ANY of the above moon conditions.</p>
        {{else}}
          <p class="hint no-moons">No moons configured in the calendar. Add moons to use moon-based events.</p>
        {{/if}}
      </fieldset>
    </div>
  {{/if}}

  {{!-- Random Configuration (shown when repeat is 'random') --}}
  {{#if showRandomConfig}}
    <div class="form-row-random">
      <fieldset class="random-config-fieldset">
        <legend>Random Event Settings</legend>
        <div class="random-config-inputs">
          <div class="form-group">
            <label data-tooltip="CALENDARIA.UI.RandomProbabilityTooltip">Probability (%)</label>
            <input type="number" name="system.randomConfig.probability" value="{{randomConfig.probability}}" min="0"
              max="100" step="1" />
          </div>
          <div class="form-group">
            <label data-tooltip="CALENDARIA.UI.RandomIntervalTooltip">Check Every</label>
            <select name="system.randomConfig.checkInterval">
              {{#each randomIntervalOptions}}
                <option value="{{value}}" {{#if selected}}selected{{/if}}>{{label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="form-group">
            <label data-tooltip="CALENDARIA.UI.RandomSeedTooltip">Seed</label>
            <div class="seed-input-group">
              <input type="number" name="system.randomConfig.seed" value="{{randomConfig.seed}}" />
              <button type="button" data-action="regenerateSeed" data-tooltip="CALENDARIA.UI.RegenerateSeedTooltip">
                <i class="fas fa-dice"></i>
              </button>
            </div>
          </div>
        </div>
        <p class="hint">Event has {{randomConfig.probability}}% chance to occur each
          {{randomConfig.checkIntervalLabel}}. Same seed = same occurrences.
        </p>
      </fieldset>
    </div>
  {{/if}}

  {{!-- Linked Event Configuration (shown when repeat is 'linked') --}}
  {{#if showLinkedConfig}}
    <div class="form-row-linked">
      <fieldset class="linked-config-fieldset">
        <legend>Linked Event Settings</legend>
        <div class="linked-config-inputs">
          <select name="system.linkedEvent.noteId" data-tooltip="CALENDARIA.UI.LinkedNoteTooltip">
            <option value="">Select an event...</option>
            {{#each availableNotes}}
              <option value="{{id}}" {{#if selected}}selected{{/if}}>{{name}}</option>
            {{/each}}
          </select>
          <input type="number" name="system.linkedEvent.offset" value="{{linkedEvent.offset}}" step="1"
            placeholder="Offset" data-tooltip="CALENDARIA.UI.LinkedOffsetTooltip" />
          {{#if linkedEvent.noteId}}
            <button type="button" class="clear-linked-btn" data-action="clearLinkedEvent"
              data-tooltip="Clear linked event">
              <i class="fas fa-times"></i>
            </button>
          {{/if}}
        </div>
        <p class="hint">
          {{#if linkedEvent.noteId}}
            Linked to "{{linkedNoteName}}" with offset of {{linkedEvent.offset}} days.
          {{else}}
            Select event to link. Offset: positive = days after, negative = days before.
          {{/if}}
        </p>
      </fieldset>
    </div>
  {{/if}}

  {{!-- Range Pattern Configuration (shown when repeat is 'range') --}}
  {{#if showRangeConfig}}
    <div class="form-row-range">
      <fieldset class="range-config-fieldset">
        <legend>Range Pattern Settings</legend>
        <div class="range-config-inputs">

          {{!-- Year Configuration --}}
          <div class="range-component">
            <label>Year</label>
            <div class="range-controls">
              <select data-range-type="year" class="range-type-select">
                <option value="any" {{#if rangeYearAny}}selected{{/if}}>Any Year</option>
                <option value="exact" {{#if rangeYearExact}}selected{{/if}}>Exact Year</option>
                <option value="range" {{#if rangeYearRange}}selected{{/if}}>Year Range</option>
              </select>
              <div class="range-value-inputs">
                {{#if rangeYearExact}}
                  <input type="number" name="rangeYear" value="{{rangeYearValue}}" placeholder="Year" step="1" />
                {{else if rangeYearRange}}
                  <input type="number" name="rangeYearMin" value="{{rangeYearMin}}" placeholder="Min" step="1" />
                  <span>to</span>
                  <input type="number" name="rangeYearMax" value="{{rangeYearMax}}" placeholder="Max" step="1" />
                {{/if}}
              </div>
            </div>
          </div>

          {{!-- Month Configuration --}}
          <div class="range-component">
            <label>Month</label>
            <div class="range-controls">
              <select data-range-type="month" class="range-type-select">
                <option value="any" {{#if rangeMonthAny}}selected{{/if}}>Any Month</option>
                <option value="exact" {{#if rangeMonthExact}}selected{{/if}}>Exact Month</option>
                <option value="range" {{#if rangeMonthRange}}selected{{/if}}>Month Range</option>
              </select>
              <div class="range-value-inputs">
                {{#if rangeMonthExact}}
                  <select name="rangeMonth">
                    {{#each monthOptions}}
                      <option value="{{index}}" {{#if selected}}selected{{/if}}>{{name}}</option>
                    {{/each}}
                  </select>
                {{else if rangeMonthRange}}
                  <select name="rangeMonthMin">
                    {{#each monthOptions}}
                      <option value="{{index}}" {{#if selectedMin}}selected{{/if}}>{{name}}</option>
                    {{/each}}
                  </select>
                  <span>to</span>
                  <select name="rangeMonthMax">
                    {{#each monthOptions}}
                      <option value="{{index}}" {{#if selectedMax}}selected{{/if}}>{{name}}</option>
                    {{/each}}
                  </select>
                {{/if}}
              </div>
            </div>
          </div>

          {{!-- Day Configuration --}}
          <div class="range-component">
            <label>Day</label>
            <div class="range-controls">
              <select data-range-type="day" class="range-type-select">
                <option value="any" {{#if rangeDayAny}}selected{{/if}}>Any Day</option>
                <option value="exact" {{#if rangeDayExact}}selected{{/if}}>Exact Day</option>
                <option value="range" {{#if rangeDayRange}}selected{{/if}}>Day Range</option>
              </select>
              <div class="range-value-inputs">
                {{#if rangeDayExact}}
                  <input type="number" name="rangeDay" value="{{rangeDayValue}}" placeholder="Day" min="1" max="31"
                    step="1" />
                {{else if rangeDayRange}}
                  <input type="number" name="rangeDayMin" value="{{rangeDayMin}}" placeholder="Min" min="1" max="31"
                    step="1" />
                  <span>to</span>
                  <input type="number" name="rangeDayMax" value="{{rangeDayMax}}" placeholder="Max" min="1" max="31"
                    step="1" />
                {{/if}}
              </div>
            </div>
          </div>

        </div>
        <p class="hint">
          Define a pattern matching specific years, months, and days. Use ranges for events spanning multiple periods.
          Example: Year 2020-2025, Month January, Day 15th = "Every January 15 from 2020 to 2025"
        </p>
      </fieldset>
    </div>
  {{/if}}

  {{!-- Row 3: Categories --}}
  <div class="form-row-3">
    <fieldset class="categories-fieldset">
      <legend>Categories</legend>
      <div class="categories-container">
        <multi-select name="system.categories">
          {{#each categoryOptions}}
            <option value="{{id}}" {{#if selected}}selected{{/if}} {{#if custom}}data-custom="true" {{/if}}>{{label}}
            </option>
          {{/each}}
        </multi-select>
        <div class="custom-category-input">
          <input type="text" class="new-category-input" placeholder="New category..." />
          <button type="button" class="add-category-btn" data-action="addCategory" data-tooltip="Add custom category">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </div>
    </fieldset>
  </div>

  {{!-- Row 4: Macro --}}
  <div class="form-row-4">
    <fieldset class="macro-fieldset">
      <legend>Macro</legend>
      <select name="system.macro" data-tooltip="CALENDARIA.UI.MacroTooltip">
        <option value="">None</option>
        {{#each availableMacros}}
          <option value="{{id}}" {{#if selected}}selected{{/if}}>{{name}}</option>
        {{/each}}
      </select>
      <p class="hint">Execute when this event triggers or each day of multi-day events.</p>
    </fieldset>
  </div>

  {{!-- Bottom row: ProseMirror Editor --}}
  <fieldset class="editor-fieldset">
    <legend>Note Content</legend>
    <prose-mirror id="note-content" name="text.content" value="{{text.content}}" aria-label="Note Content">
    </prose-mirror>
  </fieldset>
</div>
